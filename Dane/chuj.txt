import sounddevice as sd
import matplotlib.pyplot as plt
import numpy as np
from matplotlib.animation import FuncAnimation
import queue

# list = sd.rec(frames=5*44100,samplerate=44100,channels=2)
# sd.wait()
# plt.plot(list)
# plt.show()
#
downsample = 1
window = 1000
interval = 30
fs = 44100
q = queue.Queue()
length = int(window*fs/(1000*downsample))
plotdata = np.zeros((length, 1))

t = 5
n = np.arange(0, t, 1/fs)
data = np.zeros(t*fs)
n_frames = t*fs

devices = sd.query_devices()
mic_name = devices[1]['name']

fig, ax = plt.subplots()
plt.title("Real time microphone input")
plt.xlabel("Time [s]")
plt.ylabel("Amplitude")
ax.set_ylim(-1, 1)
lines = plt.plot(plotdata)


def audio_callback(indata, frames, time, status):
    data = np.sum(indata, axis=1)
    q.put(data[::downsample])


def update_plot(frame):
    global plotdata

    while True:
        try:
            data = q.get_nowait()
        except queue.Empty:
            break
        shift = len(data)
        plotdata = np.roll(plotdata, -shift, axis=0)
        plotdata[-shift:, :] = data.reshape((-1, 1))

    for line in lines:
        line.set_ydata(plotdata[:, 0])

    return lines



input = sd.InputStream(samplerate=fs, channels=2, device=1, callback=audio_callback)

ani = FuncAnimation(fig, update_plot, interval=interval, blit=True, cache_frame_data=False)

with input:
    plt.show()